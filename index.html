<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التواصل المفتوحة</title>
    <style>
        :root { --bg-gray: #f0f2f5; --white: #ffffff; --primary: #0084ff; --text: #1c1e21; }
        body { background: var(--bg-gray); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; justify-content: center; height: 100vh; }
        
        .chat-container { width: 100%; max-width: 800px; background: var(--white); display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        header { padding: 15px 20px; background: var(--white); border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .user-badge { background: #e7f3ff; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }

        #messages-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: #f9f9f9; }
        
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 18px; position: relative; font-size: 0.95rem; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg.other { background: #e4e6eb; align-self: flex-start; border-bottom-right-radius: 4px; }
        .msg.me { background: var(--primary); color: #fff; align-self: flex-end; border-bottom-left-radius: 4px; }
        .msg-info { font-size: 0.7rem; margin-bottom: 4px; display: block; opacity: 0.7; }

        .input-bar { padding: 15px 20px; background: var(--white); border-top: 1px solid #ddd; display: flex; gap: 10px; }
        input { flex: 1; border: none; background: #f0f2f5; padding: 12px 18px; border-radius: 25px; outline: none; font-size: 1rem; }
        button { background: none; border: none; color: var(--primary); font-weight: bold; cursor: pointer; padding: 0 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="chat-container">
    <header>
        <div style="font-weight: bold; font-size: 1.2rem;">المراسلة الفورية</div>
        <div id="identity" class="user-badge">زائر...</div>
    </header>

    <div id="messages-flow">
        </div>

    <div class="input-bar">
        <input type="text" id="msg-input" placeholder="اكتب رسالة..." autocomplete="off">
        <button id="send-btn">إرسال</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBGbP9HXebg4Z5WabWF4CEq9zJ5QEHO7PU",
        databaseURL: "https://realtime-database-df34b-default-rtdb.firebaseio.com",
        projectId: "realtime-database-df34b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const chatRef = db.ref('global_chat_v3');

    // نظام الهوية (Guest Logic)
    let myName = localStorage.getItem('guest_name');
    if (!myName) {
        myName = "زائر_" + Math.floor(Math.random() * 9000 + 1000);
        localStorage.setItem('guest_name', myName);
    }
    document.getElementById('identity').innerText = myName;

    const flow = document.getElementById('messages-flow');
    const input = document.getElementById('msg-input');

    function send() {
        if(input.value.trim() !== "") {
            chatRef.push({
                user: myName,
                text: input.value,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            input.value = "";
        }
    }

    document.getElementById('send-btn').onclick = send;
    input.onkeypress = (e) => { if(e.key === 'Enter') send(); };

    // تحميل وعرض الرسائل
    chatRef.limitToLast(100).on('child_added', (snap) => {
        const data = snap.val();
        const isMe = data.user === myName;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'other'}`;
        div.innerHTML = `
            <span class="msg-info">${isMe ? 'أنا' : data.user}</span>
            <div class="text">${data.text}</div>
            <span style="font-size:0.6rem; display:block; text-align:right; margin-top:4px;">${data.time}</span>
        `;
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
    });
</script>

</body>
</html>
