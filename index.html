<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-CORE | صراع النصال الخارق</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap');
        
        :root { --gold: #d4af37; --blood: #8b0000; }
        body { margin: 0; background: #050505; color: var(--gold); font-family: 'Amiri', serif; overflow: hidden; touch-action: none; }

        /* واجهة الدخول والرومات */
        #ui-layer {
            position: fixed; inset: 0; z-index: 100;
            background: radial-gradient(circle, #1a0a05, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .royal-box {
            border: 2px solid var(--gold); padding: 30px; background: rgba(0,0,0,0.8);
            box-shadow: 0 0 30px var(--blood); text-align: center; width: 300px;
        }
        input { 
            width: 100%; padding: 12px; background: #000; border: 1px solid var(--gold); 
            color: #fff; text-align: center; margin-bottom: 15px; font-size: 1.1rem;
        }
        .btn {
            background: var(--gold); color: #000; border: none; padding: 10px 20px;
            font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s;
        }
        .btn:hover { background: #fff; box-shadow: 0 0 15px var(--gold); }

        /* شاشة اللعب */
        #game-canvas { display: none; background: url('https://www.transparenttextures.com/patterns/dark-matter.png'); }
        
        /* أدوات التحكم للهاتف */
        #controls {
            position: fixed; bottom: 20px; width: 100%; display: none;
            justify-content: space-between; padding: 0 30px; box-sizing: border-box;
        }
        .joystick { width: 80px; height: 80px; background: rgba(212,175,55,0.2); border-radius: 50%; border: 2px solid var(--gold); }
        #atk-btn { width: 70px; height: 70px; background: var(--blood); border: 2px solid var(--gold); border-radius: 50%; color: #fff; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="royal-box" id="login-box">
            <h1 style="font-size: 2rem;">نِزالُ الأساطير</h1>
            <input type="text" id="username" placeholder="ادخل اسمك الملكي" maxlength="8">
            <button class="btn" onclick="showRooms()">دخول</button>
        </div>

        <div class="royal-box" id="room-box" style="display:none;">
            <h2>اختر قاعة النزال</h2>
            <div id="rooms-list"></div>
            <input type="text" id="new-room" placeholder="اسم قاعة جديدة">
            <button class="btn" onclick="joinRoom()">بدء القتال</button>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="controls">
        <div class="joystick" id="move-pad"></div>
        <button id="atk-btn">ATTACK</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGbP9HXebg4Z5WabWF4CEq9zJ5QEHO7PU",
            databaseURL: "https://realtime-database-df34b-default-rtdb.firebaseio.com",
            projectId: "realtime-database-df34b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "";
        let currentRoom = "";
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let players = {};

        function showRooms() {
            myName = document.getElementById('username').value.trim();
            if(myName.length < 3) return alert("الاسم قصير!");
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('room-box').style.display = 'block';
        }

        function joinRoom() {
            currentRoom = document.getElementById('new-room').value || "MainArena";
            document.getElementById('ui-layer').style.display = 'none';
            canvas.style.display = 'block';
            if('ontouchstart' in window) document.getElementById('controls').style.display = 'flex';
            
            initGame();
        }

        function initGame() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const playerRef = db.ref(`rooms/${currentRoom}/players/${myName}`);
            playerRef.set({ x: 100, y: 300, dir: 1, action: 'idle', hp: 100 });
            playerRef.onDisconnect().remove();

            // الاستماع لكل اللاعبين
            db.ref(`rooms/${currentRoom}/players`).on('value', snap => {
                players = snap.val() || {};
            });

            gameLoop();
        }

        // نظام التحريك والأنميشن الخارق
        function drawPlayer(id, p) {
            ctx.save();
            ctx.translate(p.x, p.y);
            
            // الظل
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath(); ctx.ellipse(0, 45, 20, 5, 0, 0, Math.PI*2); ctx.fill();

            // رسم الشخصية (سيلويت محارب)
            ctx.scale(p.dir, 1);
            ctx.fillStyle = (id === myName) ? "#d4af37" : "#8b0000";
            
            // الجسد (تغيير الارتفاع لمحاكاة التنفس)
            let breathe = Math.sin(Date.now() / 200) * 2;
            ctx.fillRect(-15, -40 + breathe, 30, 80); 
            
            // السيف
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
            if(p.action === 'attack') {
                ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(50, -20); ctx.stroke();
                // تأثير ضربة (Flash)
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.beginPath(); ctx.arc(40, -10, 15, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.beginPath(); ctx.moveTo(10, 20); ctx.lineTo(30, -30); ctx.stroke();
            }

            // الاسم
            ctx.scale(p.dir, 1);
            ctx.fillStyle = "#fff"; ctx.font = "14px Amiri";
            ctx.fillText(id, -20, -60);
            ctx.restore();
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // رسم الحلبة
            ctx.strokeStyle = "rgba(212,175,55,0.2)";
            for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }

            // رسم كل اللاعبين
            Object.keys(players).forEach(id => {
                drawPlayer(id, players[id]);
            });

            requestAnimationFrame(gameLoop);
        }

        // التحكم (PC)
        window.addEventListener('keydown', e => {
            const p = players[myName];
            if(!p) return;
            let updates = { action: 'idle' };
            
            if(e.key === 'ArrowRight') { updates.x = p.x + 15; updates.dir = 1; }
            if(e.key === 'ArrowLeft') { updates.x = p.x - 15; updates.dir = -1; }
            if(e.code === 'Space') { 
                updates.action = 'attack';
                setTimeout(() => db.ref(`rooms/${currentRoom}/players/${myName}/action`).set('idle'), 200);
            }
            db.ref(`rooms/${currentRoom}/players/${myName}`).update(updates);
        });

        // الهجوم للهاتف
        document.getElementById('atk-btn').addEventListener('touchstart', () => {
            db.ref(`rooms/${currentRoom}/players/${myName}/action`).set('attack');
            setTimeout(() => db.ref(`rooms/${currentRoom}/players/${myName}/action`).set('idle'), 200);
        });
    </script>
</body>
</html>
