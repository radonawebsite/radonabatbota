<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-CORE | نزال العروش 3D</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@900&family=Amiri:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Amiri', serif; }
        
        /* واجهة الدخول الملكية */
        #auth-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #2b0202, #000);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .royal-card {
            background: #1a0a05; border: 2px solid #d4af37; padding: 40px;
            text-align: center; width: 300px; box-shadow: 0 0 50px #000;
        }
        input { 
            width: 100%; padding: 12px; background: #000; border: 1px solid #d4af37; 
            color: #d4af37; text-align: center; margin-bottom: 20px; font-size: 1.2rem;
        }
        .btn-gold {
            background: #d4af37; color: #000; border: none; padding: 10px 30px;
            font-weight: 900; cursor: pointer; width: 100%;
        }

        /* أدوات التحكم للهاتف (تظهر فقط في شاشات اللمس) */
        #mobile-controls {
            position: fixed; bottom: 30px; left: 30px; width: 120px; height: 120px;
            background: rgba(212, 175, 55, 0.2); border-radius: 50%; border: 2px solid #d4af37;
            display: none; z-index: 500; touch-action: none;
        }
        #joystick-stick {
            position: absolute; top: 35px; left: 35px; width: 50px; height: 50px;
            background: #d4af37; border-radius: 50%;
        }
        #attack-btn {
            position: fixed; bottom: 40px; right: 40px; width: 80px; height: 80px;
            background: #4a0404; border: 3px solid #d4af37; border-radius: 50%;
            display: none; z-index: 500; color: #d4af37; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="royal-card">
            <h1 style="color:#d4af37; font-family:'Playfair Display'">الولوج المباشر</h1>
            <input type="text" id="username" placeholder="اكتب اسمك الملكي" maxlength="6">
            <button class="btn-gold" onclick="enterArena()">دخول الحلبة</button>
        </div>
    </div>

    <div id="mobile-controls"><div id="joystick-stick"></div></div>
    <button id="attack-btn">هجوم!</button>

    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/build/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGbP9HXebg4Z5WabWF4CEq9zJ5QEHO7PU",
            databaseURL: "https://realtime-database-df34b-default-rtdb.firebaseio.com",
            projectId: "realtime-database-df34b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId = "";
        let scene, camera, renderer, playerBox;
        let otherPlayers = {};
        const moveSpeed = 0.15;

        // فحص نوع الجهاز لتفعيل أزرار الهاتف
        if ('ontouchstart' in window) {
            document.getElementById('mobile-controls').style.display = 'block';
            document.getElementById('attack-btn').style.display = 'block';
        }

        function enterArena() {
            myId = document.getElementById('username').value.trim();
            if(!myId || myId.length < 3) return alert("الاسم قصير جداً");
            
            document.getElementById('auth-overlay').style.display = 'none';
            init3D();
            syncWithFirebase();
        }

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // أرضية فيكتورية مذهبة
            const floorGeo = new THREE.PlaneGeometry(50, 50);
            const floorMat = new THREE.MeshPhongMaterial({ color: 0x1a1a1a, side: THREE.DoubleSide });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = Math.PI / 2;
            scene.add(floor);

            // إضاءة درامية
            const light = new THREE.PointLight(0xd4af37, 2, 100);
            light.position.set(0, 10, 0);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));

            // إنشاء لاعبك (تاج ذهبي مبسط)
            const playerGeo = new THREE.ConeGeometry(0.5, 1, 8);
            const playerMat = new THREE.MeshPhongMaterial({ color: 0xd4af37 });
            playerBox = new THREE.Mesh(playerGeo, playerMat);
            playerBox.position.y = 0.5;
            scene.add(playerBox);

            camera.position.set(0, 5, 10);
            camera.lookAt(playerBox.position);

            animate();
        }

        function syncWithFirebase() {
            const playerRef = db.ref('arena/players/' + myId);
            playerRef.set({ x: 0, z: 0, hp: 100 });
            playerRef.onDisconnect().remove();

            db.ref('arena/players').on('value', snap => {
                const data = snap.val() || {};
                Object.keys(data).forEach(id => {
                    if(id !== myId) {
                        if(!otherPlayers[id]) {
                            const enemyGeo = new THREE.BoxGeometry(0.8, 0.8, 0.8);
                            const enemyMat = new THREE.MeshPhongMaterial({ color: 0x4a0404 });
                            otherPlayers[id] = new THREE.Mesh(enemyGeo, enemyMat);
                            scene.add(otherPlayers[id]);
                        }
                        otherPlayers[id].position.set(data[id].x, 0.4, data[id].z);
                    }
                });
                // إزالة اللاعبين الخارجين
                Object.keys(otherPlayers).forEach(id => {
                    if(!data[id]) {
                        scene.remove(otherPlayers[id]);
                        delete otherPlayers[id];
                    }
                });
            });
        }

        // نظام التحكم المزدوج (PC + Mobile)
        const keys = {};
        window.onkeydown = (e) => keys[e.key] = true;
        window.onkeyup = (e) => keys[e.key] = false;

        function animate() {
            requestAnimationFrame(animate);
            
            let moved = false;
            if(keys['ArrowUp'] || keys['w']) { playerBox.position.z -= moveSpeed; moved = true; }
            if(keys['ArrowDown'] || keys['s']) { playerBox.position.z += moveSpeed; moved = true; }
            if(keys['ArrowLeft'] || keys['a']) { playerBox.position.x -= moveSpeed; moved = true; }
            if(keys['ArrowRight'] || keys['d']) { playerBox.position.x += moveSpeed; moved = true; }

            if(moved) {
                db.ref('arena/players/' + myId).update({
                    x: playerBox.position.x,
                    z: playerBox.position.z
                });
                camera.position.x = playerBox.position.x;
                camera.position.z = playerBox.position.z + 10;
            }
            
            renderer.render(scene, camera);
        }

        // تحكم الجويستيك للهاتف (بسيط)
        let touchX = 0, touchY = 0;
        document.getElementById('mobile-controls').addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const dx = (touch.clientX - centerX) / 50;
            const dy = (touch.clientY - centerY) / 50;
            
            playerBox.position.x += dx * moveSpeed;
            playerBox.position.z += dy * moveSpeed;
            db.ref('arena/players/' + myId).update({ x: playerBox.position.x, z: playerBox.position.z });
        });
    </script>
</body>
</html>
